diff --git a/packages/nx/src/plugins/js/index.ts b/packages/nx/src/plugins/js/index.ts
index 70a584d5e2..99ff689c15 100644
--- a/packages/nx/src/plugins/js/index.ts
+++ b/packages/nx/src/plugins/js/index.ts
@@ -2,10 +2,7 @@ import { execSync } from 'child_process';
 import { mkdirSync, readFileSync, writeFileSync } from 'fs';
 import { dirname, join } from 'path';
 import { performance } from 'perf_hooks';
-import {
-  ProjectGraph,
-  ProjectGraphExternalNode,
-} from '../../config/project-graph';
+import { ProjectGraph } from '../../config/project-graph';
 import { hashArray } from '../../hasher/file-hasher';
 import {
   CreateDependencies,
@@ -35,7 +32,6 @@ export const name = 'nx/js/dependencies-and-lockfile';
 
 // Separate in-memory caches
 let cachedExternalNodes: ProjectGraph['externalNodes'] | undefined;
-let cachedKeyMap: Map<string, any> | undefined;
 
 export const createNodesV2: CreateNodesV2 = [
   combineGlobPatterns(LOCKFILES),
@@ -69,25 +65,23 @@ function internalCreateNodes(
   const lockFileHash = getLockFileHash(lockFileContents);
 
   if (!lockFileNeedsReprocessing(lockFileHash, externalNodesHashFile)) {
-    const { nodes, keyMap } = readCachedExternalNodes();
+    const nodes = readCachedExternalNodes();
     cachedExternalNodes = nodes;
-    cachedKeyMap = keyMap;
 
     return {
       externalNodes: nodes,
     };
   }
 
-  const { nodes: externalNodes, keyMap } = getLockFileNodes(
+  const externalNodes = getLockFileNodes(
     packageManager,
     lockFileContents,
     lockFileHash,
     context
   );
   cachedExternalNodes = externalNodes;
-  cachedKeyMap = keyMap;
 
-  writeExternalNodesCache(lockFileHash, externalNodes, keyMap);
+  writeExternalNodesCache(lockFileHash, externalNodes);
 
   return {
     externalNodes,
@@ -123,8 +117,7 @@ export const createDependencies: CreateDependencies = (
         packageManager,
         lockFileContents,
         lockFileHash,
-        ctx,
-        cachedKeyMap
+        ctx
       );
 
       writeDependenciesCache(lockFileHash, lockfileDependencies);
@@ -149,49 +142,6 @@ function getLockFileHash(lockFileContents: string) {
   return hashArray([nxVersion, lockFileContents]);
 }
 
-// Serialize keyMap to JSON-friendly format
-function serializeKeyMap(keyMap: Map<string, any>): Record<string, any> {
-  const serialized: Record<string, any> = {};
-  for (const [key, value] of keyMap.entries()) {
-    if (value instanceof Set) {
-      // pnpm: Map<string, Set<ProjectGraphExternalNode>>
-      serialized[key] = Array.from(value).map((node) => node.name);
-    } else if (value && typeof value === 'object' && 'name' in value) {
-      // npm/yarn: Map<string, ProjectGraphExternalNode>
-      serialized[key] = value.name;
-    } else {
-      serialized[key] = value;
-    }
-  }
-  return serialized;
-}
-
-// Deserialize keyMap from JSON format using ctx.externalNodes
-function deserializeKeyMap(
-  serialized: Record<string, any>,
-  externalNodes: Record<string, ProjectGraphExternalNode>
-): Map<string, any> {
-  const keyMap = new Map<string, any>();
-  for (const [key, value] of Object.entries(serialized)) {
-    if (Array.isArray(value)) {
-      // pnpm: reconstruct Set<ProjectGraphExternalNode>
-      const nodes = value
-        .map((nodeName) => externalNodes[nodeName])
-        .filter(Boolean);
-      keyMap.set(key, new Set(nodes));
-    } else if (typeof value === 'string') {
-      // npm/yarn: reconstruct ProjectGraphExternalNode
-      const node = externalNodes[value];
-      if (node) {
-        keyMap.set(key, node);
-      }
-    } else {
-      keyMap.set(key, value);
-    }
-  }
-  return keyMap;
-}
-
 function lockFileNeedsReprocessing(lockHash: string, hashFilePath: string) {
   try {
     return readFileSync(hashFilePath).toString() !== lockHash;
@@ -203,24 +153,15 @@ function lockFileNeedsReprocessing(lockHash: string, hashFilePath: string) {
 // External nodes cache functions
 function writeExternalNodesCache(
   hash: string,
-  nodes: ProjectGraph['externalNodes'],
-  keyMap: Map<string, any>
+  nodes: ProjectGraph['externalNodes']
 ) {
   mkdirSync(dirname(externalNodesHashFile), { recursive: true });
-  const serializedKeyMap = serializeKeyMap(keyMap);
-  const cacheData = { nodes, keyMap: serializedKeyMap };
-  writeFileSync(externalNodesCache, JSON.stringify(cacheData, null, 2));
+  writeFileSync(externalNodesCache, JSON.stringify(nodes, null, 2));
   writeFileSync(externalNodesHashFile, hash);
 }
 
-function readCachedExternalNodes(): {
-  nodes: ProjectGraph['externalNodes'];
-  keyMap: Map<string, any>;
-} {
-  const { nodes, keyMap } = JSON.parse(
-    readFileSync(externalNodesCache, 'utf-8')
-  );
-  return { nodes, keyMap: deserializeKeyMap(keyMap, nodes) };
+function readCachedExternalNodes(): ProjectGraph['externalNodes'] {
+  return JSON.parse(readFileSync(externalNodesCache).toString());
 }
 
 // Dependencies cache functions
diff --git a/packages/nx/src/plugins/js/lock-file/lock-file.ts b/packages/nx/src/plugins/js/lock-file/lock-file.ts
index ce6ee4fc85..f1dbcce76b 100644
--- a/packages/nx/src/plugins/js/lock-file/lock-file.ts
+++ b/packages/nx/src/plugins/js/lock-file/lock-file.ts
@@ -74,10 +74,7 @@ export function getLockFileNodes(
   contents: string,
   lockFileHash: string,
   context: CreateNodesContextV2
-): {
-  nodes: Record<string, ProjectGraphExternalNode>;
-  keyMap: Map<string, any>;
-} {
+): Record<string, ProjectGraphExternalNode> {
   try {
     if (packageManager === 'yarn') {
       const packageJson = readJsonFile(
@@ -95,8 +92,7 @@ export function getLockFileNodes(
       const lockFilePath = getLockFilePath(packageManager);
       if (lockFilePath.endsWith(BUN_TEXT_LOCK_FILE)) {
         // Use new text-based parser
-        const nodes = getBunTextLockfileNodes(contents, lockFileHash);
-        return { nodes, keyMap: new Map() };
+        return getBunTextLockfileNodes(contents, lockFileHash);
       } else {
         // Fallback to yarn parser for binary format
         const packageJson = readJsonFile(
@@ -124,47 +120,25 @@ export function getLockFileDependencies(
   packageManager: PackageManager,
   contents: string,
   lockFileHash: string,
-  context: CreateDependenciesContext,
-  keyMap: Map<string, any>
+  context: CreateDependenciesContext
 ): RawProjectGraphDependency[] {
   try {
     if (packageManager === 'yarn') {
-      return getYarnLockfileDependencies(
-        contents,
-        lockFileHash,
-        context,
-        keyMap
-      );
+      return getYarnLockfileDependencies(contents, lockFileHash, context);
     }
     if (packageManager === 'pnpm') {
-      return getPnpmLockfileDependencies(
-        contents,
-        lockFileHash,
-        context,
-        keyMap
-      );
+      return getPnpmLockfileDependencies(contents, lockFileHash, context);
     }
     if (packageManager === 'npm') {
-      return getNpmLockfileDependencies(
-        contents,
-        lockFileHash,
-        context,
-        keyMap
-      );
+      return getNpmLockfileDependencies(contents, lockFileHash, context);
     }
     if (packageManager === 'bun') {
       const lockFilePath = getLockFilePath(packageManager);
       if (lockFilePath.endsWith(BUN_TEXT_LOCK_FILE)) {
-        // Bun parser doesn't use keyMap
         return getBunTextLockfileDependencies(contents, lockFileHash, context);
       } else {
         // Fallback to yarn parser for binary format
-        return getYarnLockfileDependencies(
-          contents,
-          lockFileHash,
-          context,
-          keyMap
-        );
+        return getYarnLockfileDependencies(contents, lockFileHash, context);
       }
     }
   } catch (e) {
diff --git a/packages/nx/src/plugins/js/lock-file/npm-parser.spec.ts b/packages/nx/src/plugins/js/lock-file/npm-parser.spec.ts
index 06d6e653d5..6465d5a8e3 100644
--- a/packages/nx/src/plugins/js/lock-file/npm-parser.spec.ts
+++ b/packages/nx/src/plugins/js/lock-file/npm-parser.spec.ts
@@ -33,7 +33,7 @@ describe('NPM lock file utility', () => {
 
     beforeEach(() => {
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getNpmLockfileNodes(
+      const externalNodes = getNpmLockfileNodes(
         JSON.stringify(rootLockFile),
         hash
       );
@@ -59,8 +59,7 @@ describe('NPM lock file utility', () => {
       const dependencies = getNpmLockfileDependencies(
         JSON.stringify(rootLockFile),
         hash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(pg);
@@ -91,7 +90,7 @@ describe('NPM lock file utility', () => {
 
       // this is original generated lock file
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getNpmLockfileNodes(
+      const externalNodes = getNpmLockfileNodes(
         JSON.stringify(appLockFile),
         hash
       );
@@ -117,8 +116,7 @@ describe('NPM lock file utility', () => {
       const dependencies = getNpmLockfileDependencies(
         JSON.stringify(appLockFile),
         hash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(pg);
@@ -177,7 +175,7 @@ describe('NPM lock file utility', () => {
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getNpmLockfileNodes(
+      const externalNodes = getNpmLockfileNodes(
         JSON.stringify(rootLockFile),
         hash
       );
@@ -203,8 +201,7 @@ describe('NPM lock file utility', () => {
       const dependencies = getNpmLockfileDependencies(
         JSON.stringify(rootLockFile),
         hash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(pg);
@@ -274,7 +271,7 @@ describe('NPM lock file utility', () => {
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getNpmLockfileNodes(
+      const externalNodes = getNpmLockfileNodes(
         JSON.stringify(rootV2LockFile),
         hash
       );
@@ -300,8 +297,7 @@ describe('NPM lock file utility', () => {
       const dependencies = getNpmLockfileDependencies(
         JSON.stringify(rootV2LockFile),
         hash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(pg);
@@ -411,7 +407,7 @@ describe('NPM lock file utility', () => {
       cleanupTypes(prunedV2LockFile.dependencies, true);
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getNpmLockfileNodes(
+      const externalNodes = getNpmLockfileNodes(
         JSON.stringify(rootV2LockFile),
         hash
       );
@@ -437,8 +433,7 @@ describe('NPM lock file utility', () => {
       const dependencies = getNpmLockfileDependencies(
         JSON.stringify(rootV2LockFile),
         hash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(pg);
@@ -537,7 +532,7 @@ describe('NPM lock file utility', () => {
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getNpmLockfileNodes(
+      const externalNodes = getNpmLockfileNodes(
         JSON.stringify(rootLockFile),
         hash
       );
@@ -563,8 +558,7 @@ describe('NPM lock file utility', () => {
       const dependencies = getNpmLockfileDependencies(
         JSON.stringify(rootLockFile),
         hash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(pg);
@@ -587,7 +581,7 @@ describe('NPM lock file utility', () => {
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getNpmLockfileNodes(
+      const externalNodes = getNpmLockfileNodes(
         JSON.stringify(rootLockFile),
         hash
       );
@@ -613,8 +607,7 @@ describe('NPM lock file utility', () => {
       const dependencies = getNpmLockfileDependencies(
         JSON.stringify(rootLockFile),
         hash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(pg);
@@ -644,10 +637,7 @@ describe('NPM lock file utility', () => {
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getNpmLockfileNodes(
-        JSON.stringify(lockFile),
-        hash
-      );
+      const externalNodes = getNpmLockfileNodes(JSON.stringify(lockFile), hash);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -670,8 +660,7 @@ describe('NPM lock file utility', () => {
       const dependencies = getNpmLockfileDependencies(
         JSON.stringify(lockFile),
         hash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(pg);
@@ -709,7 +698,7 @@ describe('NPM lock file utility', () => {
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getNpmLockfileNodes(
+      const externalNodes = getNpmLockfileNodes(
         JSON.stringify(rootLockFile),
         hash
       );
@@ -735,8 +724,7 @@ describe('NPM lock file utility', () => {
       const dependencies = getNpmLockfileDependencies(
         JSON.stringify(rootLockFile),
         hash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(pg);
@@ -776,7 +764,7 @@ describe('NPM lock file utility', () => {
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getNpmLockfileNodes(
+      const externalNodes = getNpmLockfileNodes(
         JSON.stringify(rootLockFile),
         hash
       );
@@ -802,8 +790,7 @@ describe('NPM lock file utility', () => {
       const dependencies = getNpmLockfileDependencies(
         JSON.stringify(rootLockFile),
         hash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(pg);
@@ -854,7 +841,7 @@ describe('NPM lock file utility', () => {
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getNpmLockfileNodes(
+      const externalNodes = getNpmLockfileNodes(
         JSON.stringify(rootLockFile),
         hash
       );
@@ -880,8 +867,7 @@ describe('NPM lock file utility', () => {
       const dependencies = getNpmLockfileDependencies(
         JSON.stringify(rootLockFile),
         hash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(pg);
@@ -924,7 +910,7 @@ describe('NPM lock file utility', () => {
         '__fixtures__/workspaces/package-lock.json'
       ));
 
-      const { nodes: externalNodes } = getNpmLockfileNodes(
+      const externalNodes = getNpmLockfileNodes(
         JSON.stringify(lockFile),
         uniq('mock-hash')
       );
@@ -937,7 +923,7 @@ describe('NPM lock file utility', () => {
         __dirname,
         '__fixtures__/workspaces/package-lock.v1.json'
       ));
-      const { nodes: externalNodes } = getNpmLockfileNodes(
+      const externalNodes = getNpmLockfileNodes(
         JSON.stringify(lockFile),
         uniq('mock')
       );
@@ -962,7 +948,7 @@ describe('NPM lock file utility', () => {
         '__fixtures__/mixed-keys/package.json'
       ));
 
-      const { nodes: externalNodes, keyMap } = getNpmLockfileNodes(
+      const externalNodes = getNpmLockfileNodes(
         JSON.stringify(lockFile),
         lockFileHash
       );
@@ -988,8 +974,7 @@ describe('NPM lock file utility', () => {
       const dependencies = getNpmLockfileDependencies(
         JSON.stringify(lockFile),
         lockFileHash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(graph);
diff --git a/packages/nx/src/plugins/js/lock-file/npm-parser.ts b/packages/nx/src/plugins/js/lock-file/npm-parser.ts
index 1f8e7a4cab..f9b8817cc6 100644
--- a/packages/nx/src/plugins/js/lock-file/npm-parser.ts
+++ b/packages/nx/src/plugins/js/lock-file/npm-parser.ts
@@ -56,6 +56,9 @@ type NpmLockFile = {
   packages?: Record<string, NpmDependencyV3>;
   dependencies?: Record<string, NpmDependencyV1>;
 };
+
+// we use key => node map to avoid duplicate work when parsing keys
+let keyMap = new Map<string, ProjectGraphExternalNode>();
 let currentLockFileHash: string;
 
 let parsedLockFile: NpmLockFile;
@@ -65,6 +68,7 @@ function parsePackageLockFile(lockFileContent: string, lockFileHash: string) {
     return parsedLockFile;
   }
 
+  keyMap.clear();
   const results = JSON.parse(lockFileContent) as NpmLockFile;
   parsedLockFile = results;
   currentLockFileHash = lockFileHash;
@@ -74,23 +78,20 @@ function parsePackageLockFile(lockFileContent: string, lockFileHash: string) {
 export function getNpmLockfileNodes(
   lockFileContent: string,
   lockFileHash: string
-): {
-  nodes: Record<string, ProjectGraphExternalNode>;
-  keyMap: Map<string, ProjectGraphExternalNode>;
-} {
+) {
   const data = parsePackageLockFile(
     lockFileContent,
     lockFileHash
   ) as NpmLockFile;
 
-  return getNodes(data);
+  // we use key => node map to avoid duplicate work when parsing keys
+  return getNodes(data, keyMap);
 }
 
 export function getNpmLockfileDependencies(
   lockFileContent: string,
   lockFileHash: string,
-  ctx: CreateDependenciesContext,
-  keyMap: Map<string, ProjectGraphExternalNode>
+  ctx: CreateDependenciesContext
 ) {
   const data = parsePackageLockFile(
     lockFileContent,
@@ -100,11 +101,10 @@ export function getNpmLockfileDependencies(
   return getDependencies(data, keyMap, ctx);
 }
 
-function getNodes(data: NpmLockFile): {
-  nodes: Record<string, ProjectGraphExternalNode>;
-  keyMap: Map<string, ProjectGraphExternalNode>;
-} {
-  const keyMap = new Map<string, ProjectGraphExternalNode>();
+function getNodes(
+  data: NpmLockFile,
+  keyMap: Map<string, ProjectGraphExternalNode>
+) {
   const nodes: Map<string, Map<string, ProjectGraphExternalNode>> = new Map();
 
   if (data.lockfileVersion > 1) {
@@ -164,7 +164,7 @@ function getNodes(data: NpmLockFile): {
       results[node.name] = node;
     });
   }
-  return { nodes: results, keyMap };
+  return results;
 }
 
 function addV1Node(
diff --git a/packages/nx/src/plugins/js/lock-file/pnpm-parser.spec.ts b/packages/nx/src/plugins/js/lock-file/pnpm-parser.spec.ts
index 0aade0d299..e289f5090f 100644
--- a/packages/nx/src/plugins/js/lock-file/pnpm-parser.spec.ts
+++ b/packages/nx/src/plugins/js/lock-file/pnpm-parser.spec.ts
@@ -4,10 +4,7 @@ import {
   getPnpmLockfileDependencies,
   stringifyPnpmLockfile,
 } from './pnpm-parser';
-import {
-  ProjectGraph,
-  type ProjectGraphExternalNode,
-} from '../../../config/project-graph';
+import { ProjectGraph } from '../../../config/project-graph';
 import { vol } from 'memfs';
 import { pruneProjectGraph } from './project-graph-pruning';
 import {
@@ -131,7 +128,6 @@ describe('pnpm LockFile utility', () => {
     });
 
     let externalNodes: ProjectGraph['externalNodes'];
-    let keyMap: Map<string, Set<ProjectGraphExternalNode>>;
     let dependencies: RawProjectGraphDependency[];
     let graph: ProjectGraph;
 
@@ -146,9 +142,7 @@ describe('pnpm LockFile utility', () => {
         )).default;
         lockFileHash = '__fixtures__/nextjs/pnpm-lock.yaml';
 
-        const result = getPnpmLockfileNodes(lockFile, lockFileHash);
-        externalNodes = result.nodes;
-        keyMap = result.keyMap;
+        externalNodes = getPnpmLockfileNodes(lockFile, lockFileHash);
         graph = {
           nodes: {},
           dependencies: {},
@@ -168,12 +162,7 @@ describe('pnpm LockFile utility', () => {
           nxJsonConfiguration: null,
           workspaceRoot: '/virtual',
         };
-        dependencies = getPnpmLockfileDependencies(
-          lockFile,
-          lockFileHash,
-          ctx,
-          keyMap
-        );
+        dependencies = getPnpmLockfileDependencies(lockFile, lockFileHash, ctx);
 
         const builder = new ProjectGraphBuilder(graph);
         for (const dep of dependencies) {
@@ -225,9 +214,7 @@ describe('pnpm LockFile utility', () => {
           '__fixtures__/nextjs/pnpm-lock-v6.yaml'
         )).default;
         lockFileHash = '__fixtures__/nextjs/pnpm-lock-v6.yaml';
-        const result = getPnpmLockfileNodes(lockFile, lockFileHash);
-        externalNodes = result.nodes;
-        keyMap = result.keyMap;
+        externalNodes = getPnpmLockfileNodes(lockFile, lockFileHash);
         graph = {
           nodes: {},
           dependencies: {},
@@ -247,12 +234,7 @@ describe('pnpm LockFile utility', () => {
           nxJsonConfiguration: null,
           workspaceRoot: '/virtual',
         };
-        dependencies = getPnpmLockfileDependencies(
-          lockFile,
-          lockFileHash,
-          ctx,
-          keyMap
-        );
+        dependencies = getPnpmLockfileDependencies(lockFile, lockFileHash, ctx);
 
         const builder = new ProjectGraphBuilder(graph);
         for (const dep of dependencies) {
@@ -282,7 +264,7 @@ describe('pnpm LockFile utility', () => {
         )).default;
         const appLockFileHash = '__fixtures__/nextjs/app/pnpm-lock-v6.yaml';
 
-        const { nodes: externalNodes, keyMap } = getPnpmLockfileNodes(
+        const externalNodes = getPnpmLockfileNodes(
           appLockFile,
           appLockFileHash
         );
@@ -308,8 +290,7 @@ describe('pnpm LockFile utility', () => {
         const dependencies = getPnpmLockfileDependencies(
           appLockFile,
           appLockFileHash,
-          appCtx,
-          keyMap
+          appCtx
         );
 
         const builder = new ProjectGraphBuilder(appGraph);
@@ -375,10 +356,7 @@ describe('pnpm LockFile utility', () => {
       )).default;
       const lockFileHash = '__fixtures__/auxiliary-packages/pnpm-lock.yaml';
 
-      const { nodes: externalNodes, keyMap } = getPnpmLockfileNodes(
-        lockFile,
-        lockFileHash
-      );
+      const externalNodes = getPnpmLockfileNodes(lockFile, lockFileHash);
       let graph: ProjectGraph = {
         nodes: {},
         dependencies: {},
@@ -401,8 +379,7 @@ describe('pnpm LockFile utility', () => {
       const dependencies = getPnpmLockfileDependencies(
         lockFile,
         lockFileHash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(graph);
@@ -496,10 +473,7 @@ describe('pnpm LockFile utility', () => {
         },
       };
 
-      const { nodes: externalNodes, keyMap } = getPnpmLockfileNodes(
-        lockFile,
-        lockFileHash
-      );
+      const externalNodes = getPnpmLockfileNodes(lockFile, lockFileHash);
       let graph: ProjectGraph = {
         nodes: {},
         dependencies: {},
@@ -522,8 +496,7 @@ describe('pnpm LockFile utility', () => {
       const dependencies = getPnpmLockfileDependencies(
         lockFile,
         lockFileHash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(graph);
@@ -575,10 +548,7 @@ describe('pnpm LockFile utility', () => {
       )).default;
       const lockFileHash = '__fixtures__/duplicate-package/pnpm-lock.yaml';
 
-      const { nodes: externalNodes, keyMap } = getPnpmLockfileNodes(
-        lockFile,
-        lockFileHash
-      );
+      const externalNodes = getPnpmLockfileNodes(lockFile, lockFileHash);
       let graph: ProjectGraph = {
         nodes: {},
         dependencies: {},
@@ -601,8 +571,7 @@ describe('pnpm LockFile utility', () => {
       const dependencies = getPnpmLockfileDependencies(
         lockFile,
         lockFileHash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(graph);
@@ -639,10 +608,7 @@ describe('pnpm LockFile utility', () => {
         '__fixtures__/optional/pnpm-lock.yaml'
       )).default;
       const lockFileHash = '__fixtures__/optional/pnpm-lock.yaml';
-      const { nodes: externalNodes, keyMap } = getPnpmLockfileNodes(
-        lockFile,
-        lockFileHash
-      );
+      const externalNodes = getPnpmLockfileNodes(lockFile, lockFileHash);
       let graph: ProjectGraph = {
         nodes: {},
         dependencies: {},
@@ -665,8 +631,7 @@ describe('pnpm LockFile utility', () => {
       const dependencies = getPnpmLockfileDependencies(
         lockFile,
         lockFileHash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(graph);
@@ -716,10 +681,7 @@ describe('pnpm LockFile utility', () => {
         )).default;
         lockFileHash = '__fixtures__/pruning/pnpm-lock.yaml';
 
-        const { nodes: externalNodes, keyMap } = getPnpmLockfileNodes(
-          lockFile,
-          lockFileHash
-        );
+        const externalNodes = getPnpmLockfileNodes(lockFile, lockFileHash);
         graph = {
           nodes: {},
           dependencies: {},
@@ -742,8 +704,7 @@ describe('pnpm LockFile utility', () => {
         const dependencies = getPnpmLockfileDependencies(
           lockFile,
           lockFileHash,
-          ctx,
-          keyMap
+          ctx
         );
 
         const builder = new ProjectGraphBuilder(graph);
@@ -821,10 +782,7 @@ describe('pnpm LockFile utility', () => {
         )).default;
         lockFileHash = '__fixtures__/pruning/pnpm-lock-v6.yaml';
 
-        const { nodes: externalNodes, keyMap } = getPnpmLockfileNodes(
-          lockFile,
-          lockFileHash
-        );
+        const externalNodes = getPnpmLockfileNodes(lockFile, lockFileHash);
         graph = {
           nodes: {},
           dependencies: {},
@@ -847,8 +805,7 @@ describe('pnpm LockFile utility', () => {
         const dependencies = getPnpmLockfileDependencies(
           lockFile,
           lockFileHash,
-          ctx,
-          keyMap
+          ctx
         );
 
         const builder = new ProjectGraphBuilder(graph);
@@ -926,10 +883,7 @@ describe('pnpm LockFile utility', () => {
         )).default;
         lockFileHash = '__fixtures__/pruning/pnpm-lock-v9.yaml';
 
-        const { nodes: externalNodes, keyMap } = getPnpmLockfileNodes(
-          lockFile,
-          lockFileHash
-        );
+        const externalNodes = getPnpmLockfileNodes(lockFile, lockFileHash);
         graph = {
           nodes: {},
           dependencies: {},
@@ -952,8 +906,7 @@ describe('pnpm LockFile utility', () => {
         const dependencies = getPnpmLockfileDependencies(
           lockFile,
           lockFileHash,
-          ctx,
-          keyMap
+          ctx
         );
 
         const builder = new ProjectGraphBuilder(graph);
@@ -1045,10 +998,7 @@ describe('pnpm LockFile utility', () => {
     });
 
     it('should parse lock file', async () => {
-      const { nodes: externalNodes } = getPnpmLockfileNodes(
-        lockFile,
-        lockFileHash
-      );
+      const externalNodes = getPnpmLockfileNodes(lockFile, lockFileHash);
       expect(Object.keys(externalNodes).length).toEqual(5);
     });
   });
@@ -1094,10 +1044,7 @@ describe('pnpm LockFile utility', () => {
         '__fixtures__/mixed-keys/package.json'
       ));
 
-      const { nodes: externalNodes, keyMap } = getPnpmLockfileNodes(
-        lockFile,
-        lockFileHash
-      );
+      const externalNodes = getPnpmLockfileNodes(lockFile, lockFileHash);
       let graph: ProjectGraph = {
         nodes: {},
         dependencies: {},
@@ -1120,8 +1067,7 @@ describe('pnpm LockFile utility', () => {
       const dependencies = getPnpmLockfileDependencies(
         lockFile,
         lockFileHash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(graph);
@@ -1351,10 +1297,7 @@ describe('pnpm LockFile utility', () => {
         '__fixtures__/mixed-keys/package.json'
       ));
 
-      const { nodes: externalNodes, keyMap } = getPnpmLockfileNodes(
-        lockFile,
-        lockFileHash
-      );
+      const externalNodes = getPnpmLockfileNodes(lockFile, lockFileHash);
       let graph: ProjectGraph = {
         nodes: {},
         dependencies: {},
@@ -1377,8 +1320,7 @@ describe('pnpm LockFile utility', () => {
       const dependencies = getPnpmLockfileDependencies(
         lockFile,
         lockFileHash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(graph);
@@ -1626,10 +1568,7 @@ describe('pnpm LockFile utility', () => {
         '__fixtures__/pnpm-regression/package.json'
       ));
 
-      const { nodes: externalNodes, keyMap } = getPnpmLockfileNodes(
-        lockFile,
-        lockFileHash
-      );
+      const externalNodes = getPnpmLockfileNodes(lockFile, lockFileHash);
       let graph: ProjectGraph = {
         nodes: {},
         dependencies: {},
@@ -1652,8 +1591,7 @@ describe('pnpm LockFile utility', () => {
       const dependencies = getPnpmLockfileDependencies(
         lockFile,
         lockFileHash,
-        ctx,
-        keyMap
+        ctx
       );
 
       const builder = new ProjectGraphBuilder(graph);
diff --git a/packages/nx/src/plugins/js/lock-file/pnpm-parser.ts b/packages/nx/src/plugins/js/lock-file/pnpm-parser.ts
index b4155eeecb..ea71cd45f5 100644
--- a/packages/nx/src/plugins/js/lock-file/pnpm-parser.ts
+++ b/packages/nx/src/plugins/js/lock-file/pnpm-parser.ts
@@ -30,6 +30,9 @@ import { getCatalogManager } from '../../../utils/catalog';
 import { findNodeMatchingVersion } from './project-graph-pruning';
 import { join } from 'path';
 import { getWorkspacePackagesFromGraph } from '../utils/get-workspace-packages-from-graph';
+
+// we use key => node map to avoid duplicate work when parsing keys
+let keyMap = new Map<string, Set<ProjectGraphExternalNode>>();
 let currentLockFileHash: string;
 
 let parsedLockFile: Lockfile;
@@ -42,6 +45,7 @@ function parsePnpmLockFile(
     return parsedLockFile;
   }
 
+  keyMap.clear();
   const results = parseAndNormalizePnpmLockfile(lockFileContent);
   parsedLockFile = results;
   currentLockFileHash = lockFileHash;
@@ -51,10 +55,7 @@ function parsePnpmLockFile(
 export function getPnpmLockfileNodes(
   lockFileContent: string,
   lockFileHash: string
-): {
-  nodes: Record<string, ProjectGraphExternalNode>;
-  keyMap: Map<string, Set<ProjectGraphExternalNode>>;
-} {
+): Record<string, ProjectGraphExternalNode> {
   const data = parsePnpmLockFile(lockFileContent, lockFileHash);
   if (+data.lockfileVersion.toString() >= 10) {
     console.warn(
@@ -62,14 +63,13 @@ export function getPnpmLockfileNodes(
     );
   }
   const isV5 = isV5Syntax(data);
-  return getNodes(data, isV5);
+  return getNodes(data, keyMap, isV5);
 }
 
 export function getPnpmLockfileDependencies(
   lockFileContent: string,
   lockFileHash: string,
-  ctx: CreateDependenciesContext,
-  keyMap: Map<string, Set<ProjectGraphExternalNode>>
+  ctx: CreateDependenciesContext
 ) {
   const data = parsePnpmLockFile(lockFileContent, lockFileHash);
   if (+data.lockfileVersion.toString() >= 10) {
@@ -129,12 +129,9 @@ function isAliasVersion(depVersion: string) {
 
 function getNodes(
   data: Lockfile,
+  keyMap: Map<string, Set<ProjectGraphExternalNode>>,
   isV5: boolean
-): {
-  nodes: Record<string, ProjectGraphExternalNode>;
-  keyMap: Map<string, Set<ProjectGraphExternalNode>>;
-} {
-  const keyMap = new Map<string, Set<ProjectGraphExternalNode>>();
+): Record<string, ProjectGraphExternalNode> {
   const nodes: Map<string, Map<string, ProjectGraphExternalNode>> = new Map();
 
   const maybeAliasedPackageVersions = new Map<string, string>(); // <version, alias>
@@ -334,7 +331,7 @@ function getNodes(
       results[node.name] = node;
     });
   }
-  return { nodes: results, keyMap };
+  return results;
 }
 
 function getHoistedVersion(
diff --git a/packages/nx/src/plugins/js/lock-file/yarn-parser.spec.ts b/packages/nx/src/plugins/js/lock-file/yarn-parser.spec.ts
index 31e0936bce..5a913f1210 100644
--- a/packages/nx/src/plugins/js/lock-file/yarn-parser.spec.ts
+++ b/packages/nx/src/plugins/js/lock-file/yarn-parser.spec.ts
@@ -183,11 +183,7 @@ describe('yarn LockFile utility', () => {
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -207,12 +203,7 @@ describe('yarn LockFile utility', () => {
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
@@ -430,7 +421,7 @@ describe('yarn LockFile utility', () => {
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
+      const externalNodes = getYarnLockfileNodes(
         classicLockFile,
         hash,
         packageJson
@@ -516,11 +507,7 @@ describe('yarn LockFile utility', () => {
       )).default;
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -540,12 +527,7 @@ describe('yarn LockFile utility', () => {
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
@@ -594,7 +576,7 @@ describe('yarn LockFile utility', () => {
       )).default;
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
+      const externalNodes = getYarnLockfileNodes(
         lockFile,
         hash,
         normalizedPackageJson
@@ -618,12 +600,7 @@ describe('yarn LockFile utility', () => {
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
@@ -661,7 +638,7 @@ describe('yarn LockFile utility', () => {
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
+      const externalNodes = getYarnLockfileNodes(
         berryLockFile,
         hash,
         packageJson
@@ -748,11 +725,7 @@ describe('yarn LockFile utility', () => {
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -772,12 +745,7 @@ describe('yarn LockFile utility', () => {
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
@@ -840,11 +808,7 @@ __metadata:
         };
 
         const hash = uniq('mock-hash');
-        const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-          lockFile,
-          hash,
-          packageJson
-        );
+        const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
         const pg = {
           nodes: {},
           dependencies: {},
@@ -864,12 +828,7 @@ __metadata:
           nxJsonConfiguration: null,
           workspaceRoot: '/virtual',
         };
-        const dependencies = getYarnLockfileDependencies(
-          lockFile,
-          hash,
-          ctx,
-          keyMap
-        );
+        const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
         const builder = new ProjectGraphBuilder(pg);
         for (const dep of dependencies) {
@@ -944,11 +903,7 @@ __metadata:
         };
 
         const hash = uniq('mock-hash');
-        const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-          lockFile,
-          hash,
-          packageJson
-        );
+        const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
 
         expect(externalNodes).toMatchInlineSnapshot(`
                   {
@@ -1026,11 +981,7 @@ __metadata:
         };
 
         const hash = uniq('mock-hash');
-        const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-          lockFile,
-          hash,
-          packageJson
-        );
+        const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
         const pg = {
           nodes: {},
           dependencies: {},
@@ -1050,12 +1001,7 @@ __metadata:
           nxJsonConfiguration: null,
           workspaceRoot: '/virtual',
         };
-        const dependencies = getYarnLockfileDependencies(
-          lockFile,
-          hash,
-          ctx,
-          keyMap
-        );
+        const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
         const builder = new ProjectGraphBuilder(pg);
         for (const dep of dependencies) {
           builder.addDependency(
@@ -1154,11 +1100,7 @@ postgres@charsleysa/postgres#fix-errors-compiled:
       };
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
 
       expect(externalNodes['npm:@nrwl/nx-cloud']).toMatchInlineSnapshot(`
         {
@@ -1228,11 +1170,7 @@ postgres@charsleysa/postgres#fix-errors-compiled:
       };
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
 
       expect(externalNodes['npm:@nrwl/nx-cloud']).toMatchInlineSnapshot(`
           {
@@ -1288,11 +1226,7 @@ nx-cloud@latest:
       };
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
 
       expect(externalNodes['npm:nx-cloud']).toMatchInlineSnapshot(`
           {
@@ -1320,7 +1254,7 @@ nx-cloud@latest:
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
+      const externalNodes = getYarnLockfileNodes(
         berryLockFile,
         hash,
         packageJson
@@ -1436,7 +1370,7 @@ nx-cloud@latest:
         '__fixtures__/duplicate-package/package.json'
       ));
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
+      const externalNodes = getYarnLockfileNodes(
         classicLockFile,
         hash,
         packageJson
@@ -1471,11 +1405,7 @@ nx-cloud@latest:
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -1495,12 +1425,7 @@ nx-cloud@latest:
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
@@ -1695,11 +1620,7 @@ nx-cloud@latest:
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -1719,12 +1640,7 @@ nx-cloud@latest:
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
@@ -1767,11 +1683,7 @@ nx-cloud@latest:
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -1791,12 +1703,7 @@ nx-cloud@latest:
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
@@ -1844,11 +1751,7 @@ nx-cloud@latest:
         '__fixtures__/workspaces/package.json'
       ));
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
 
       expect(Object.keys(externalNodes).length).toEqual(5);
     });
@@ -1863,11 +1766,7 @@ nx-cloud@latest:
         '__fixtures__/workspaces/package.json'
       ));
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
 
       expect(Object.keys(externalNodes).length).toEqual(5);
     });
@@ -1933,11 +1832,7 @@ type-fest@^0.20.2:
         },
       };
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -1957,12 +1852,7 @@ type-fest@^0.20.2:
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
@@ -2061,11 +1951,7 @@ __metadata:
       };
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -2085,12 +1971,7 @@ __metadata:
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
@@ -2199,11 +2080,7 @@ __metadata:
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -2223,12 +2100,7 @@ __metadata:
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
@@ -2451,11 +2323,7 @@ __metadata:
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -2475,12 +2343,7 @@ __metadata:
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
@@ -2755,11 +2618,7 @@ __metadata:
       };
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
 
       expect(externalNodes).toMatchInlineSnapshot(`
         {
@@ -2858,11 +2717,7 @@ __metadata:
       };
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -2882,12 +2737,7 @@ __metadata:
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
@@ -2993,11 +2843,7 @@ __metadata:
       };
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -3017,12 +2863,7 @@ __metadata:
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
 
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
@@ -3103,11 +2944,7 @@ __metadata:
       ));
 
       const hash = uniq('mock-hash');
-      const { nodes: externalNodes, keyMap } = getYarnLockfileNodes(
-        lockFile,
-        hash,
-        packageJson
-      );
+      const externalNodes = getYarnLockfileNodes(lockFile, hash, packageJson);
       const pg = {
         nodes: {},
         dependencies: {},
@@ -3127,12 +2964,7 @@ __metadata:
         nxJsonConfiguration: null,
         workspaceRoot: '/virtual',
       };
-      const dependencies = getYarnLockfileDependencies(
-        lockFile,
-        hash,
-        ctx,
-        keyMap
-      );
+      const dependencies = getYarnLockfileDependencies(lockFile, hash, ctx);
       const builder = new ProjectGraphBuilder(pg);
       for (const dep of dependencies) {
         builder.addDependency(
diff --git a/packages/nx/src/plugins/js/lock-file/yarn-parser.ts b/packages/nx/src/plugins/js/lock-file/yarn-parser.ts
index eb21340210..22c79f4106 100644
--- a/packages/nx/src/plugins/js/lock-file/yarn-parser.ts
+++ b/packages/nx/src/plugins/js/lock-file/yarn-parser.ts
@@ -43,6 +43,9 @@ type YarnDependency = {
 let currentLockFileHash: string;
 let cachedParsedLockFile;
 
+// we use key => node map to avoid duplicate work when parsing keys
+let keyMap = new Map<string, ProjectGraphExternalNode>();
+
 function parseLockFile(lockFileContent: string, lockFileHash: string) {
   if (currentLockFileHash === lockFileHash) {
     return cachedParsedLockFile;
@@ -51,6 +54,7 @@ function parseLockFile(lockFileContent: string, lockFileHash: string) {
   const { parseSyml } =
     require('@yarnpkg/parsers') as typeof import('@yarnpkg/parsers');
 
+  keyMap.clear();
   const result = parseSyml(lockFileContent);
   cachedParsedLockFile = result;
   currentLockFileHash = lockFileHash;
@@ -61,10 +65,7 @@ export function getYarnLockfileNodes(
   lockFileContent: string,
   lockFileHash: string,
   packageJson: NormalizedPackageJson
-): {
-  nodes: Record<string, ProjectGraphExternalNode>;
-  keyMap: Map<string, ProjectGraphExternalNode>;
-} {
+) {
   const { __metadata, ...dependencies } = parseLockFile(
     lockFileContent,
     lockFileHash
@@ -81,8 +82,7 @@ export function getYarnLockfileNodes(
 export function getYarnLockfileDependencies(
   lockFileContent: string,
   lockFileHash: string,
-  ctx: CreateDependenciesContext,
-  keyMap: Map<string, ProjectGraphExternalNode>
+  ctx: CreateDependenciesContext
 ) {
   const { __metadata, ...dependencies } = parseLockFile(
     lockFileContent,
@@ -94,7 +94,7 @@ export function getYarnLockfileDependencies(
   // yarn classic splits keys when parsing so we need to stich them back together
   const groupedDependencies = groupDependencies(dependencies, isBerry);
 
-  return getDependencies(groupedDependencies, ctx, keyMap);
+  return getDependencies(groupedDependencies, ctx);
 }
 
 function getPackageNameKeyPairs(keys: string): Map<string, Set<string>> {
@@ -114,11 +114,7 @@ function getNodes(
   dependencies: Record<string, YarnDependency>,
   packageJson: NormalizedPackageJson,
   isBerry: boolean
-): {
-  nodes: Record<string, ProjectGraphExternalNode>;
-  keyMap: Map<string, ProjectGraphExternalNode>;
-} {
-  const keyMap = new Map<string, ProjectGraphExternalNode>();
+) {
   const nodes: Map<string, Map<string, ProjectGraphExternalNode>> = new Map();
   const combinedDeps = {
     ...packageJson.dependencies,
@@ -194,7 +190,7 @@ function getNodes(
       externalNodes[node.name] = node;
     });
   }
-  return { nodes: externalNodes, keyMap };
+  return externalNodes;
 }
 
 function findHoistedNode(
@@ -300,8 +296,7 @@ function getHoistedVersion(packageName: string): string {
 
 function getDependencies(
   dependencies: Record<string, YarnDependency>,
-  ctx: CreateDependenciesContext,
-  keyMap: Map<string, ProjectGraphExternalNode>
+  ctx: CreateDependenciesContext
 ) {
   const projectGraphDependencies: RawProjectGraphDependency[] = [];
   Object.keys(dependencies).forEach((keys) => {
